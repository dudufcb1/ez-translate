<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Navigation Interception - EZ Translate</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #0073aa;
        }
        .success { color: #00a32a; }
        .error { color: #d63638; }
        .warning { color: #dba617; }
        .info { color: #0073aa; }
        .test-links {
            background: #fff;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .test-links a {
            display: block;
            margin: 5px 0;
            padding: 8px;
            background: #e7f3ff;
            text-decoration: none;
            border-radius: 4px;
        }
        .test-links a:hover {
            background: #cce7ff;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        button {
            background: #0073aa;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a87;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Test Navigation Interception</h1>
    <p>Esta pÃ¡gina simula el comportamiento del sistema de interceptaciÃ³n de navegaciÃ³n cuando un usuario estÃ¡ "encerrado" en un idioma especÃ­fico.</p>

    <div class="test-section">
        <h2>ğŸ“‹ ConfiguraciÃ³n de Prueba</h2>
        <div id="config-status" class="status"></div>
        
        <h3>Simular Usuario Restringido:</h3>
        <button onclick="simulateRestrictedUser('pt')">ğŸ‡µğŸ‡¹ Usuario Restringido a PortuguÃ©s</button>
        <button onclick="simulateRestrictedUser('en')">ğŸ‡¬ğŸ‡§ Usuario Restringido a InglÃ©s</button>
        <button onclick="simulateRestrictedUser('fr')">ğŸ‡«ğŸ‡· Usuario Restringido a FrancÃ©s</button>
        <button onclick="simulateFreeUser()">ğŸŒ Usuario Libre</button>
        
        <h3>Enlaces de Prueba:</h3>
        <div class="test-links">
            <a href="/?p=123" data-post-id="123">ğŸ“„ ArtÃ­culo 123 (tiene traducciÃ³n en PT y EN)</a>
            <a href="/?p=456" data-post-id="456">ğŸ“„ ArtÃ­culo 456 (solo tiene traducciÃ³n en EN)</a>
            <a href="/?p=789" data-post-id="789">ğŸ“„ ArtÃ­culo 789 (sin traducciones)</a>
            <a href="/sample-post/" data-post-id="999">ğŸ“„ Post con permalink bonito</a>
            <a href="#anchor">ğŸ”— Enlace ancla (no debe interceptar)</a>
            <a href="https://google.com">ğŸŒ Enlace externo (no debe interceptar)</a>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š Resultados de Prueba</h2>
        <div id="test-results"></div>
        <div id="console-log" class="log"></div>
    </div>

    <script>
        // Mock data para simular las traducciones disponibles
        const mockTranslations = {
            123: [
                { language_code: 'pt', post_id: 124, url: '/?p=124', title: 'Artigo 123 em PortuguÃªs' },
                { language_code: 'en', post_id: 125, url: '/?p=125', title: 'Article 123 in English' }
            ],
            456: [
                { language_code: 'en', post_id: 457, url: '/?p=457', title: 'Article 456 in English' }
            ],
            789: [], // Sin traducciones
            999: [
                { language_code: 'pt', post_id: 1000, url: '/post-em-portugues/', title: 'Post em PortuguÃªs' }
            ]
        };

        const mockLanguages = [
            { code: 'es', name: 'EspaÃ±ol', native_name: 'EspaÃ±ol', flag: 'ğŸ‡ªğŸ‡¸', landing_page_id: null },
            { code: 'pt', name: 'Portuguese', native_name: 'PortuguÃªs', flag: 'ğŸ‡µğŸ‡¹', landing_page_id: 100 },
            { code: 'en', name: 'English', native_name: 'English', flag: 'ğŸ‡¬ğŸ‡§', landing_page_id: 200 },
            { code: 'fr', name: 'French', native_name: 'FranÃ§ais', flag: 'ğŸ‡«ğŸ‡·', landing_page_id: 300 }
        ];

        let currentUserChoice = null;
        let interceptorActive = false;

        // Mock de las funciones del detector
        function extractPostIdFromUrl(url) {
            try {
                const urlParams = new URLSearchParams(new URL(url).search);
                if (urlParams.has('p')) {
                    return parseInt(urlParams.get('p'));
                }
                
                // Para permalinks bonitos, usar el mock
                if (url.includes('sample-post')) {
                    return 999;
                }
                
                return null;
            } catch (error) {
                logToConsole('Error extracting post ID: ' + error.message, 'error');
                return null;
            }
        }

        async function findTranslationForPost(postId, targetLanguage) {
            logToConsole(`ğŸ” Buscando traducciÃ³n del post ${postId} en idioma ${targetLanguage}`, 'info');
            
            // Simular delay de API
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const translations = mockTranslations[postId] || [];
            const translation = translations.find(t => t.language_code === targetLanguage);
            
            if (translation) {
                logToConsole(`âœ… TraducciÃ³n encontrada: ${translation.url}`, 'success');
                return translation;
            } else {
                logToConsole(`âŒ No se encontrÃ³ traducciÃ³n en ${targetLanguage}`, 'warning');
                return null;
            }
        }

        function redirectToUserLanguageLanding(userLanguage) {
            const targetLang = mockLanguages.find(lang => lang.code === userLanguage);
            if (targetLang && targetLang.landing_page_id) {
                const landingUrl = `/?p=${targetLang.landing_page_id}`;
                logToConsole(`ğŸ  Redirigiendo a landing page: ${landingUrl}`, 'info');
                // En lugar de redirigir realmente, solo mostrar el resultado
                showTestResult(`RedirecciÃ³n a landing page de ${userLanguage}: ${landingUrl}`, 'info');
            } else {
                logToConsole(`ğŸ  Redirigiendo a pÃ¡gina principal`, 'info');
                showTestResult(`RedirecciÃ³n a pÃ¡gina principal (no hay landing para ${userLanguage})`, 'warning');
            }
        }

        function setupNavigationInterception() {
            if (interceptorActive) {
                logToConsole('âš ï¸ Interceptor ya estÃ¡ activo', 'warning');
                return;
            }

            if (!currentUserChoice || currentUserChoice === 'free') {
                logToConsole('â„¹ï¸ No se configura interceptor (usuario libre)', 'info');
                return;
            }

            logToConsole(`ğŸ›¡ï¸ Configurando interceptor para usuario restringido a: ${currentUserChoice}`, 'info');
            interceptorActive = true;

            document.addEventListener('click', async (e) => {
                const link = e.target.closest('a[href]');
                if (!link) return;

                const href = link.getAttribute('href');
                
                // Skip external links, anchors, and admin links
                if (!href || href.startsWith('#') || href.startsWith('mailto:') || href.startsWith('tel:') || 
                    href.includes('wp-admin') || href.includes('wp-login') || 
                    href.startsWith('http') && !href.includes(window.location.hostname)) {
                    logToConsole(`â­ï¸ Enlace ignorado: ${href}`, 'info');
                    return;
                }

                // Get the target URL
                let targetUrl;
                if (href.startsWith('/')) {
                    targetUrl = window.location.origin + href;
                } else if (href.startsWith('http')) {
                    targetUrl = href;
                } else {
                    targetUrl = new URL(href, window.location.href).href;
                }

                // Extract post ID from target URL
                const targetPostId = extractPostIdFromUrl(targetUrl);
                
                if (targetPostId) {
                    logToConsole(`ğŸ”— Interceptando navegaciÃ³n a: ${targetUrl} (Post ID: ${targetPostId})`, 'info');
                    
                    // Prevent default navigation
                    e.preventDefault();
                    
                    // Check if target post has translation in user's language
                    const translation = await findTranslationForPost(targetPostId, currentUserChoice);
                    
                    if (translation) {
                        logToConsole(`âœ… Redirigiendo a traducciÃ³n: ${translation.url}`, 'success');
                        showTestResult(`Ã‰xito: Redirigido a traducciÃ³n en ${currentUserChoice}: ${translation.url}`, 'success');
                    } else {
                        logToConsole(`âŒ No hay traducciÃ³n, redirigiendo a landing`, 'warning');
                        redirectToUserLanguageLanding(currentUserChoice);
                    }
                } else {
                    logToConsole(`â­ï¸ No se pudo extraer post ID de: ${targetUrl}`, 'info');
                }
            });
        }

        function simulateRestrictedUser(language) {
            currentUserChoice = language;
            interceptorActive = false;
            
            updateConfigStatus();
            setupNavigationInterception();
            logToConsole(`ğŸ‘¤ Usuario configurado como restringido a: ${language}`, 'info');
            clearTestResults();
        }

        function simulateFreeUser() {
            currentUserChoice = 'free';
            interceptorActive = false;
            
            updateConfigStatus();
            logToConsole(`ğŸ‘¤ Usuario configurado como libre`, 'info');
            clearTestResults();
        }

        function updateConfigStatus() {
            const statusDiv = document.getElementById('config-status');
            if (currentUserChoice && currentUserChoice !== 'free') {
                const lang = mockLanguages.find(l => l.code === currentUserChoice);
                statusDiv.innerHTML = `<strong>Estado:</strong> Usuario restringido a ${lang.flag} ${lang.native_name} (${currentUserChoice})`;
                statusDiv.className = 'status warning';
            } else {
                statusDiv.innerHTML = `<strong>Estado:</strong> Usuario con navegaciÃ³n libre`;
                statusDiv.className = 'status success';
            }
        }

        function logToConsole(message, type = 'info') {
            const logDiv = document.getElementById('console-log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#0ff',
                success: '#0f0',
                warning: '#ff0',
                error: '#f00'
            };
            
            logDiv.innerHTML += `<div style="color: ${colors[type]}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showTestResult(message, type) {
            const resultsDiv = document.getElementById('test-results');
            const colors = {
                success: '#d1edff',
                warning: '#fff3cd',
                error: '#f8d7da',
                info: '#e7f3ff'
            };
            
            resultsDiv.innerHTML += `<div style="background: ${colors[type]}; padding: 10px; margin: 5px 0; border-radius: 4px;">${message}</div>`;
        }

        function clearTestResults() {
            document.getElementById('test-results').innerHTML = '';
        }

        // Inicializar
        logToConsole('ğŸš€ Sistema de prueba inicializado', 'success');
        updateConfigStatus();
    </script>
</body>
</html>
