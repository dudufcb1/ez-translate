<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Escenario Real - EZ Translate</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .scenario {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #0073aa;
        }
        .step {
            background: #fff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .success { background: #d1edff; border-color: #0073aa; }
        .error { background: #f8d7da; border-color: #d63638; }
        .warning { background: #fff3cd; border-color: #dba617; }
        .info { background: #e7f3ff; border-color: #72aee6; }
        
        .test-link {
            display: inline-block;
            padding: 8px 16px;
            background: #0073aa;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            margin: 5px;
        }
        .test-link:hover {
            background: #005a87;
        }
        
        .log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        button {
            background: #0073aa;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a87;
        }
        
        .current-status {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            border: 1px solid #72aee6;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Test Escenario Real - Sistema de RedirecciÃ³n</h1>
    
    <div class="current-status">
        <h3>ğŸ“Š Estado Actual del Sistema</h3>
        <div id="system-status">Cargando...</div>
    </div>

    <div class="scenario">
        <h2>ğŸ¯ Escenario de Prueba</h2>
        <p><strong>SituaciÃ³n:</strong> Usuario estÃ¡ navegando en espaÃ±ol pero tiene preferencia de ver contenido en portuguÃ©s.</p>
        
        <div class="step">
            <h3>Paso 1: Configurar Usuario Restringido</h3>
            <p>Simular que el usuario eligiÃ³ "solo contenido en portuguÃ©s" en el selector de idioma.</p>
            <button onclick="setUserRestriction('pt')">ğŸ‡µğŸ‡¹ Restringir a PortuguÃ©s</button>
            <button onclick="setUserRestriction('en')">ğŸ‡¬ğŸ‡§ Restringir a InglÃ©s</button>
            <button onclick="clearUserRestriction()">ğŸŒ NavegaciÃ³n Libre</button>
        </div>

        <div class="step">
            <h3>Paso 2: Probar NavegaciÃ³n</h3>
            <p>Hacer clic en estos enlaces para ver cÃ³mo el sistema intercepta y redirige:</p>
            
            <h4>ğŸ“„ ArtÃ­culos con Traducciones:</h4>
            <a href="/?p=100" class="test-link" data-has-pt="true" data-has-en="true">ArtÃ­culo 100 (ES â†’ PT âœ…, EN âœ…)</a>
            <a href="/?p=200" class="test-link" data-has-pt="false" data-has-en="true">ArtÃ­culo 200 (ES â†’ PT âŒ, EN âœ…)</a>
            <a href="/?p=300" class="test-link" data-has-pt="true" data-has-en="false">ArtÃ­culo 300 (ES â†’ PT âœ…, EN âŒ)</a>
            <a href="/?p=400" class="test-link" data-has-pt="false" data-has-en="false">ArtÃ­culo 400 (ES â†’ PT âŒ, EN âŒ)</a>
            
            <h4>ğŸ”— Enlaces Especiales:</h4>
            <a href="/articulo-bonito/" class="test-link" data-has-pt="true">Permalink Bonito (con traducciÃ³n PT)</a>
            <a href="#seccion" class="test-link">Enlace Ancla (no debe interceptar)</a>
            <a href="https://google.com" class="test-link">Enlace Externo (no debe interceptar)</a>
        </div>

        <div class="step">
            <h3>Paso 3: Observar Resultados</h3>
            <div id="test-results"></div>
        </div>
    </div>

    <div class="scenario">
        <h2>ğŸ“‹ Log del Sistema</h2>
        <button onclick="clearLog()">ğŸ—‘ï¸ Limpiar Log</button>
        <div id="console-log" class="log"></div>
    </div>

    <script>
        // Simular configuraciÃ³n del sistema
        const mockConfig = {
            enabled: true,
            currentLanguage: 'es',
            availableLanguages: [
                { code: 'es', name: 'EspaÃ±ol', native_name: 'EspaÃ±ol', flag: 'ğŸ‡ªğŸ‡¸', landing_page_id: null },
                { code: 'pt', name: 'Portuguese', native_name: 'PortuguÃªs', flag: 'ğŸ‡µğŸ‡¹', landing_page_id: 500 },
                { code: 'en', name: 'English', native_name: 'English', flag: 'ğŸ‡¬ğŸ‡§', landing_page_id: 600 }
            ],
            config: {
                restrict_navigation: true,
                position: 'bottom-right'
            },
            postId: 1,
            restUrl: '/wp-json/ez-translate/v1/',
            homeUrl: '/'
        };

        // Mock de traducciones disponibles por post
        const mockTranslationData = {
            100: [
                { language_code: 'pt', post_id: 101, url: '/?p=101', title: 'Artigo 100 em PortuguÃªs' },
                { language_code: 'en', post_id: 102, url: '/?p=102', title: 'Article 100 in English' }
            ],
            200: [
                { language_code: 'en', post_id: 202, url: '/?p=202', title: 'Article 200 in English' }
            ],
            300: [
                { language_code: 'pt', post_id: 301, url: '/?p=301', title: 'Artigo 300 em PortuguÃªs' }
            ],
            400: [], // Sin traducciones
            999: [ // Para el permalink bonito
                { language_code: 'pt', post_id: 1000, url: '/artigo-bonito-pt/', title: 'Artigo Bonito em PortuguÃªs' }
            ]
        };

        let userChoice = null;
        let interceptorActive = false;

        // Funciones del sistema (simplificadas para testing)
        function extractPostIdFromUrl(url) {
            try {
                const urlParams = new URLSearchParams(new URL(url).search);
                if (urlParams.has('p')) {
                    return parseInt(urlParams.get('p'));
                }
                
                // Para permalinks bonitos
                if (url.includes('articulo-bonito')) {
                    return 999;
                }
                
                return null;
            } catch (error) {
                logMessage('Error extracting post ID: ' + error.message, 'error');
                return null;
            }
        }

        async function findTranslationForPost(postId, targetLanguage) {
            logMessage(`ğŸ” Buscando traducciÃ³n del post ${postId} en idioma ${targetLanguage}`, 'info');
            
            // Simular delay de API
            await new Promise(resolve => setTimeout(resolve, 200));
            
            const translations = mockTranslationData[postId] || [];
            const translation = translations.find(t => t.language_code === targetLanguage);
            
            if (translation) {
                logMessage(`âœ… TraducciÃ³n encontrada: ${translation.url}`, 'success');
                return translation;
            } else {
                logMessage(`âŒ No se encontrÃ³ traducciÃ³n en ${targetLanguage}`, 'warning');
                return null;
            }
        }

        function redirectToUserLanguageLanding(userLanguage) {
            const targetLang = mockConfig.availableLanguages.find(lang => lang.code === userLanguage);
            if (targetLang && targetLang.landing_page_id) {
                const landingUrl = `/?p=${targetLang.landing_page_id}`;
                logMessage(`ğŸ  Redirigiendo a landing page: ${landingUrl}`, 'info');
                showResult(`RedirecciÃ³n a landing page de ${userLanguage}: ${landingUrl}`, 'warning');
            } else {
                logMessage(`ğŸ  Redirigiendo a pÃ¡gina principal`, 'info');
                showResult(`RedirecciÃ³n a pÃ¡gina principal (no hay landing para ${userLanguage})`, 'warning');
            }
        }

        function setupNavigationInterception() {
            if (interceptorActive) {
                logMessage('âš ï¸ Interceptor ya estÃ¡ activo', 'warning');
                return;
            }

            const availableCodes = mockConfig.availableLanguages.map(l => l.code);
            
            if (!mockConfig.config.restrict_navigation || !userChoice || !availableCodes.includes(userChoice)) {
                logMessage('â„¹ï¸ No se configura interceptor (navegaciÃ³n libre o usuario no restringido)', 'info');
                return;
            }

            logMessage(`ğŸ›¡ï¸ Configurando interceptor para usuario restringido a: ${userChoice}`, 'info');
            interceptorActive = true;

            // Remover listener anterior si existe
            document.removeEventListener('click', navigationHandler);
            document.addEventListener('click', navigationHandler);
        }

        async function navigationHandler(e) {
            const link = e.target.closest('a[href]');
            if (!link) return;

            const href = link.getAttribute('href');
            
            // Skip external links, anchors, and admin links
            if (!href || href.startsWith('#') || href.startsWith('mailto:') || href.startsWith('tel:') || 
                href.includes('wp-admin') || href.includes('wp-login') || 
                href.startsWith('http') && !href.includes(window.location.hostname)) {
                logMessage(`â­ï¸ Enlace ignorado: ${href}`, 'info');
                return;
            }

            // Get the target URL
            let targetUrl;
            if (href.startsWith('/')) {
                targetUrl = window.location.origin + href;
            } else if (href.startsWith('http')) {
                targetUrl = href;
            } else {
                targetUrl = new URL(href, window.location.href).href;
            }

            // Extract post ID from target URL
            const targetPostId = extractPostIdFromUrl(targetUrl);
            
            if (targetPostId) {
                logMessage(`ğŸ”— Interceptando navegaciÃ³n a: ${targetUrl} (Post ID: ${targetPostId})`, 'info');
                
                // Prevent default navigation
                e.preventDefault();
                
                // Check if target post has translation in user's language
                const translation = await findTranslationForPost(targetPostId, userChoice);
                
                if (translation) {
                    logMessage(`âœ… Redirigiendo a traducciÃ³n: ${translation.url}`, 'success');
                    showResult(`âœ… Ã‰XITO: Redirigido a traducciÃ³n en ${userChoice}: ${translation.url}`, 'success');
                } else {
                    logMessage(`âŒ No hay traducciÃ³n, redirigiendo a landing`, 'warning');
                    redirectToUserLanguageLanding(userChoice);
                }
            } else {
                logMessage(`â­ï¸ No se pudo extraer post ID de: ${targetUrl}`, 'info');
            }
        }

        // Funciones de UI
        function setUserRestriction(language) {
            userChoice = language;
            interceptorActive = false;
            updateSystemStatus();
            setupNavigationInterception();
            logMessage(`ğŸ‘¤ Usuario configurado como restringido a: ${language}`, 'info');
            clearResults();
        }

        function clearUserRestriction() {
            userChoice = 'free';
            interceptorActive = false;
            updateSystemStatus();
            logMessage(`ğŸ‘¤ Usuario configurado como libre`, 'info');
            clearResults();
        }

        function updateSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            if (userChoice && userChoice !== 'free') {
                const lang = mockConfig.availableLanguages.find(l => l.code === userChoice);
                statusDiv.innerHTML = `
                    <strong>ğŸ”’ Usuario Restringido:</strong> ${lang.flag} ${lang.native_name} (${userChoice})<br>
                    <strong>ğŸ“ PÃ¡gina Actual:</strong> ${mockConfig.currentLanguage.toUpperCase()}<br>
                    <strong>ğŸ›¡ï¸ Interceptor:</strong> ${interceptorActive ? 'âœ… Activo' : 'âŒ Inactivo'}<br>
                    <strong>âš™ï¸ RestricciÃ³n:</strong> ${mockConfig.config.restrict_navigation ? 'âœ… Habilitada' : 'âŒ Deshabilitada'}
                `;
            } else {
                statusDiv.innerHTML = `
                    <strong>ğŸŒ Usuario Libre:</strong> NavegaciÃ³n sin restricciones<br>
                    <strong>ğŸ“ PÃ¡gina Actual:</strong> ${mockConfig.currentLanguage.toUpperCase()}<br>
                    <strong>ğŸ›¡ï¸ Interceptor:</strong> âŒ Inactivo
                `;
            }
        }

        function logMessage(message, type = 'info') {
            const logDiv = document.getElementById('console-log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#0ff',
                success: '#0f0',
                warning: '#ff0',
                error: '#f00'
            };
            
            logDiv.innerHTML += `<div style="color: ${colors[type]}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showResult(message, type) {
            const resultsDiv = document.getElementById('test-results');
            const colors = {
                success: '#d1edff',
                warning: '#fff3cd',
                error: '#f8d7da',
                info: '#e7f3ff'
            };
            
            resultsDiv.innerHTML += `<div class="step ${type}" style="background: ${colors[type]};">${message}</div>`;
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
        }

        function clearLog() {
            document.getElementById('console-log').innerHTML = '';
        }

        // Inicializar
        updateSystemStatus();
        logMessage('ğŸš€ Sistema de prueba de escenario real inicializado', 'success');
        logMessage('ğŸ’¡ Configura un usuario restringido y haz clic en los enlaces para probar', 'info');
    </script>
</body>
</html>
