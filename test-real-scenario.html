<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Escenario Real - EZ Translate</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .scenario {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #0073aa;
        }
        .step {
            background: #fff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .success { background: #d1edff; border-color: #0073aa; }
        .error { background: #f8d7da; border-color: #d63638; }
        .warning { background: #fff3cd; border-color: #dba617; }
        .info { background: #e7f3ff; border-color: #72aee6; }
        
        .test-link {
            display: inline-block;
            padding: 8px 16px;
            background: #0073aa;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            margin: 5px;
        }
        .test-link:hover {
            background: #005a87;
        }
        
        .log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        button {
            background: #0073aa;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a87;
        }
        
        .current-status {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            border: 1px solid #72aee6;
        }
    </style>
</head>
<body>
    <h1>🧪 Test Escenario Real - Sistema de Redirección</h1>
    
    <div class="current-status">
        <h3>📊 Estado Actual del Sistema</h3>
        <div id="system-status">Cargando...</div>
    </div>

    <div class="scenario">
        <h2>🎯 Escenario de Prueba</h2>
        <p><strong>Situación:</strong> Usuario está navegando en español pero tiene preferencia de ver contenido en portugués.</p>
        
        <div class="step">
            <h3>Paso 1: Configurar Usuario Restringido</h3>
            <p>Simular que el usuario eligió "solo contenido en portugués" en el selector de idioma.</p>
            <button onclick="setUserRestriction('pt')">🇵🇹 Restringir a Portugués</button>
            <button onclick="setUserRestriction('en')">🇬🇧 Restringir a Inglés</button>
            <button onclick="clearUserRestriction()">🌐 Navegación Libre</button>
        </div>

        <div class="step">
            <h3>Paso 2: Probar Navegación</h3>
            <p>Hacer clic en estos enlaces para ver cómo el sistema intercepta y redirige:</p>
            
            <h4>📄 Artículos con Traducciones:</h4>
            <a href="/?p=100" class="test-link" data-has-pt="true" data-has-en="true">Artículo 100 (ES → PT ✅, EN ✅)</a>
            <a href="/?p=200" class="test-link" data-has-pt="false" data-has-en="true">Artículo 200 (ES → PT ❌, EN ✅)</a>
            <a href="/?p=300" class="test-link" data-has-pt="true" data-has-en="false">Artículo 300 (ES → PT ✅, EN ❌)</a>
            <a href="/?p=400" class="test-link" data-has-pt="false" data-has-en="false">Artículo 400 (ES → PT ❌, EN ❌)</a>
            
            <h4>🔗 Enlaces Especiales:</h4>
            <a href="/articulo-bonito/" class="test-link" data-has-pt="true">Permalink Bonito (con traducción PT)</a>
            <a href="#seccion" class="test-link">Enlace Ancla (no debe interceptar)</a>
            <a href="https://google.com" class="test-link">Enlace Externo (no debe interceptar)</a>
        </div>

        <div class="step">
            <h3>Paso 3: Observar Resultados</h3>
            <div id="test-results"></div>
        </div>
    </div>

    <div class="scenario">
        <h2>📋 Log del Sistema</h2>
        <button onclick="clearLog()">🗑️ Limpiar Log</button>
        <div id="console-log" class="log"></div>
    </div>

    <script>
        // Simular configuración del sistema
        const mockConfig = {
            enabled: true,
            currentLanguage: 'es',
            availableLanguages: [
                { code: 'es', name: 'Español', native_name: 'Español', flag: '🇪🇸', landing_page_id: null },
                { code: 'pt', name: 'Portuguese', native_name: 'Português', flag: '🇵🇹', landing_page_id: 500 },
                { code: 'en', name: 'English', native_name: 'English', flag: '🇬🇧', landing_page_id: 600 }
            ],
            config: {
                restrict_navigation: true,
                position: 'bottom-right'
            },
            postId: 1,
            restUrl: '/wp-json/ez-translate/v1/',
            homeUrl: '/'
        };

        // Mock de traducciones disponibles por post
        const mockTranslationData = {
            100: [
                { language_code: 'pt', post_id: 101, url: '/?p=101', title: 'Artigo 100 em Português' },
                { language_code: 'en', post_id: 102, url: '/?p=102', title: 'Article 100 in English' }
            ],
            200: [
                { language_code: 'en', post_id: 202, url: '/?p=202', title: 'Article 200 in English' }
            ],
            300: [
                { language_code: 'pt', post_id: 301, url: '/?p=301', title: 'Artigo 300 em Português' }
            ],
            400: [], // Sin traducciones
            999: [ // Para el permalink bonito
                { language_code: 'pt', post_id: 1000, url: '/artigo-bonito-pt/', title: 'Artigo Bonito em Português' }
            ]
        };

        let userChoice = null;
        let interceptorActive = false;

        // Funciones del sistema (simplificadas para testing)
        function extractPostIdFromUrl(url) {
            try {
                const urlParams = new URLSearchParams(new URL(url).search);
                if (urlParams.has('p')) {
                    return parseInt(urlParams.get('p'));
                }
                
                // Para permalinks bonitos
                if (url.includes('articulo-bonito')) {
                    return 999;
                }
                
                return null;
            } catch (error) {
                logMessage('Error extracting post ID: ' + error.message, 'error');
                return null;
            }
        }

        async function findTranslationForPost(postId, targetLanguage) {
            logMessage(`🔍 Buscando traducción del post ${postId} en idioma ${targetLanguage}`, 'info');
            
            // Simular delay de API
            await new Promise(resolve => setTimeout(resolve, 200));
            
            const translations = mockTranslationData[postId] || [];
            const translation = translations.find(t => t.language_code === targetLanguage);
            
            if (translation) {
                logMessage(`✅ Traducción encontrada: ${translation.url}`, 'success');
                return translation;
            } else {
                logMessage(`❌ No se encontró traducción en ${targetLanguage}`, 'warning');
                return null;
            }
        }

        function redirectToUserLanguageLanding(userLanguage) {
            const targetLang = mockConfig.availableLanguages.find(lang => lang.code === userLanguage);
            if (targetLang && targetLang.landing_page_id) {
                const landingUrl = `/?p=${targetLang.landing_page_id}`;
                logMessage(`🏠 Redirigiendo a landing page: ${landingUrl}`, 'info');
                showResult(`Redirección a landing page de ${userLanguage}: ${landingUrl}`, 'warning');
            } else {
                logMessage(`🏠 Redirigiendo a página principal`, 'info');
                showResult(`Redirección a página principal (no hay landing para ${userLanguage})`, 'warning');
            }
        }

        function setupNavigationInterception() {
            if (interceptorActive) {
                logMessage('⚠️ Interceptor ya está activo', 'warning');
                return;
            }

            const availableCodes = mockConfig.availableLanguages.map(l => l.code);
            
            if (!mockConfig.config.restrict_navigation || !userChoice || !availableCodes.includes(userChoice)) {
                logMessage('ℹ️ No se configura interceptor (navegación libre o usuario no restringido)', 'info');
                return;
            }

            logMessage(`🛡️ Configurando interceptor para usuario restringido a: ${userChoice}`, 'info');
            interceptorActive = true;

            // Remover listener anterior si existe
            document.removeEventListener('click', navigationHandler);
            document.addEventListener('click', navigationHandler);
        }

        async function navigationHandler(e) {
            const link = e.target.closest('a[href]');
            if (!link) return;

            const href = link.getAttribute('href');
            
            // Skip external links, anchors, and admin links
            if (!href || href.startsWith('#') || href.startsWith('mailto:') || href.startsWith('tel:') || 
                href.includes('wp-admin') || href.includes('wp-login') || 
                href.startsWith('http') && !href.includes(window.location.hostname)) {
                logMessage(`⏭️ Enlace ignorado: ${href}`, 'info');
                return;
            }

            // Get the target URL
            let targetUrl;
            if (href.startsWith('/')) {
                targetUrl = window.location.origin + href;
            } else if (href.startsWith('http')) {
                targetUrl = href;
            } else {
                targetUrl = new URL(href, window.location.href).href;
            }

            // Extract post ID from target URL
            const targetPostId = extractPostIdFromUrl(targetUrl);
            
            if (targetPostId) {
                logMessage(`🔗 Interceptando navegación a: ${targetUrl} (Post ID: ${targetPostId})`, 'info');
                
                // Prevent default navigation
                e.preventDefault();
                
                // Check if target post has translation in user's language
                const translation = await findTranslationForPost(targetPostId, userChoice);
                
                if (translation) {
                    logMessage(`✅ Redirigiendo a traducción: ${translation.url}`, 'success');
                    showResult(`✅ ÉXITO: Redirigido a traducción en ${userChoice}: ${translation.url}`, 'success');
                } else {
                    logMessage(`❌ No hay traducción, redirigiendo a landing`, 'warning');
                    redirectToUserLanguageLanding(userChoice);
                }
            } else {
                logMessage(`⏭️ No se pudo extraer post ID de: ${targetUrl}`, 'info');
            }
        }

        // Funciones de UI
        function setUserRestriction(language) {
            userChoice = language;
            interceptorActive = false;
            updateSystemStatus();
            setupNavigationInterception();
            logMessage(`👤 Usuario configurado como restringido a: ${language}`, 'info');
            clearResults();
        }

        function clearUserRestriction() {
            userChoice = 'free';
            interceptorActive = false;
            updateSystemStatus();
            logMessage(`👤 Usuario configurado como libre`, 'info');
            clearResults();
        }

        function updateSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            if (userChoice && userChoice !== 'free') {
                const lang = mockConfig.availableLanguages.find(l => l.code === userChoice);
                statusDiv.innerHTML = `
                    <strong>🔒 Usuario Restringido:</strong> ${lang.flag} ${lang.native_name} (${userChoice})<br>
                    <strong>📍 Página Actual:</strong> ${mockConfig.currentLanguage.toUpperCase()}<br>
                    <strong>🛡️ Interceptor:</strong> ${interceptorActive ? '✅ Activo' : '❌ Inactivo'}<br>
                    <strong>⚙️ Restricción:</strong> ${mockConfig.config.restrict_navigation ? '✅ Habilitada' : '❌ Deshabilitada'}
                `;
            } else {
                statusDiv.innerHTML = `
                    <strong>🌐 Usuario Libre:</strong> Navegación sin restricciones<br>
                    <strong>📍 Página Actual:</strong> ${mockConfig.currentLanguage.toUpperCase()}<br>
                    <strong>🛡️ Interceptor:</strong> ❌ Inactivo
                `;
            }
        }

        function logMessage(message, type = 'info') {
            const logDiv = document.getElementById('console-log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#0ff',
                success: '#0f0',
                warning: '#ff0',
                error: '#f00'
            };
            
            logDiv.innerHTML += `<div style="color: ${colors[type]}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showResult(message, type) {
            const resultsDiv = document.getElementById('test-results');
            const colors = {
                success: '#d1edff',
                warning: '#fff3cd',
                error: '#f8d7da',
                info: '#e7f3ff'
            };
            
            resultsDiv.innerHTML += `<div class="step ${type}" style="background: ${colors[type]};">${message}</div>`;
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
        }

        function clearLog() {
            document.getElementById('console-log').innerHTML = '';
        }

        // Inicializar
        updateSystemStatus();
        logMessage('🚀 Sistema de prueba de escenario real inicializado', 'success');
        logMessage('💡 Configura un usuario restringido y haz clic en los enlaces para probar', 'info');
    </script>
</body>
</html>
